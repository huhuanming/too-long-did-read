---
import BaseLayout from '../../layouts/BaseLayout.astro';
import LanguageToggle from '../../components/LanguageToggle.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.data.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const formattedDate = post.data.date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout title={post.data.titleEn}>
  <article>
    <header class="mb-10">
      <div class="flex items-center gap-3 mb-4">
        <time class="text-sm text-zinc-500 tabular-nums">{formattedDate}</time>
        <span class="text-zinc-700">|</span>
        <a
          href={post.data.originalUrl}
          class="text-sm text-violet-400 hover:text-violet-300 transition-colors"
          target="_blank"
          rel="noopener noreferrer"
        >
          Original &rarr;
        </a>
        <span class="text-zinc-700">|</span>
        <button
          id="share-btn"
          class="inline-flex items-center gap-1 text-sm text-violet-400 hover:text-violet-300 transition-colors"
        >
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path d="M4 12v7a2 2 0 002 2h12a2 2 0 002-2v-7M16 6l-4-4-4 4M12 2v13" />
          </svg>
          <span id="share-label">Share</span>
        </button>
      </div>
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight text-zinc-100 leading-tight">
        {post.data.titleEn}
      </h1>
      <p class="mt-2 text-lg sm:text-xl text-zinc-500 leading-tight">
        {post.data.titleZh}
      </p>
    </header>

    <div class="mb-8 sticky top-14 z-10 py-3 bg-surface-0/90 backdrop-blur-md">
      <LanguageToggle />
    </div>

    <div
      id="article-content"
      class="prose prose-invert max-w-none
             prose-headings:font-semibold prose-headings:tracking-tight
             prose-h2:text-xl prose-h2:text-zinc-100
             prose-h3:text-lg prose-h3:text-zinc-200
             prose-p:leading-relaxed prose-p:text-zinc-400
             prose-li:leading-relaxed prose-li:text-zinc-400
             prose-strong:text-zinc-200
             prose-a:text-violet-400 prose-a:no-underline hover:prose-a:text-violet-300
             prose-blockquote:border-l-violet-500/30 prose-blockquote:text-zinc-500
             prose-hr:border-zinc-800"
    >
      <Content />
    </div>
  </article>

  <div class="mt-16 pt-8 border-t border-zinc-800">
    <a
      href="/"
      class="inline-flex items-center gap-2 text-sm text-zinc-500 hover:text-violet-400 transition-colors"
    >
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      All posts
    </a>
  </div>
</BaseLayout>

<script>
  function splitContent() {
    const prose = document.getElementById('article-content');
    if (!prose) return;

    const children = Array.from(prose.children);
    const enWrapper = document.createElement('div');
    enWrapper.id = 'content-en';
    const zhWrapper = document.createElement('div');
    zhWrapper.id = 'content-zh';

    let current = enWrapper;

    for (const child of children) {
      const text = child.textContent?.trim() || '';

      if (child.tagName === 'H2' && text === 'English') {
        current = enWrapper;
        continue;
      }
      if (child.tagName === 'H2' && text.includes('中文翻译')) {
        current = zhWrapper;
        continue;
      }
      if (child.tagName === 'HR') {
        continue;
      }

      current.appendChild(child);
    }

    prose.innerHTML = '';
    prose.appendChild(enWrapper);
    prose.appendChild(zhWrapper);

    document.dispatchEvent(new Event('content-split-done'));
  }

  splitContent();
  document.addEventListener('astro:after-swap', splitContent);
</script>

<script>
  function initShare() {
    const btn = document.getElementById('share-btn');
    const label = document.getElementById('share-label');
    if (!btn || !label) return;

    btn.addEventListener('click', async () => {
      const url = window.location.href;
      const title = document.title;

      if (navigator.share) {
        try {
          await navigator.share({ title, url });
        } catch (_) { /* user cancelled */ }
        return;
      }

      try {
        await navigator.clipboard.writeText(url);
        label.textContent = 'Copied!';
        setTimeout(() => { label.textContent = 'Share'; }, 2000);
      } catch (_) {
        // fallback: select from a temp input
        const input = Object.assign(document.createElement('input'), { value: url });
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        input.remove();
        label.textContent = 'Copied!';
        setTimeout(() => { label.textContent = 'Share'; }, 2000);
      }
    });
  }

  initShare();
  document.addEventListener('astro:after-swap', initShare);
</script>
